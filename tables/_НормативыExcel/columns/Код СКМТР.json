{
  "type": "calculated",
  "name": "Код СКМТР",
  "dataType": "string",
  "isDataTypeInferred": true,
  "expression": [
    "VAR tKodNSI=IFERROR(FORMAT(VALUE('_НормативыExcel'[_Код НСИилиСКМТР]),\"000000000\"),\"(&~\")",
    "VAR tKodSKMTR=IFERROR(FORMAT(VALUE('_НормативыExcel'[_Код НСИилиСКМТР]),\"0000000000\"),\"(&~\")",
    "VAR tEd=UPPER( '_НормативыExcel'[ЕдИзм] )",
    "",
    "VAR  tTableBySKMTR = FILTER(",
    "    '_НоменклатураКСНСИ',",
    "    '_НоменклатураКСНСИ'[Код_СК_МТР] = tKodSKMTR",
    "    && '_НоменклатураКСНСИ'[ЕдиницаИзмерения] = tEd",
    ")",
    "",
    "VAR  tTableByNSI = FILTER(",
    "    '_НоменклатураКСНСИ',",
    "    '_НоменклатураКСНСИ'[Код] = tKodNSI",
    "    && '_НоменклатураКСНСИ'[ЕдиницаИзмерения] = tEd",
    ")",
    "",
    "VAR tCountNSI=COUNTROWS(tTableByNSI)",
    "VAR tCountSKMTR=COUNTROWS(tTableBySKMTR)",
    "",
    "VAR tRet=SWITCH(TRUE(),",
    "    '_НормативыExcel'[Тип] IN { \"ЦУНР\", \"ЦУНР+\" }, ",
    "        IFERROR(FORMAT(VALUE('_НормативыExcel'[_Код НСИилиСКМТР]),\"0000000000\"),'_НормативыExcel'[_Код НСИилиСКМТР]),",
    "    tCountNSI = 1,",
    "        MAXX(tTableByNSI,'_НоменклатураКСНСИ'[Код_СК_МТР]),",
    "    BLANK()",
    ")",
    "",
    "RETURN",
    "tRet"
  ]
}